<!DOCTYPE html>
<html lang="en">

<head>
    <title>My BCIT Project</title>
    <meta name="comp1800 template" content="My 1800 App">

    <!------------------------>
    <!-- Required meta tags -->
    <!------------------------>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!------------------------------------------>
    <!-- Bootstrap Library CSS JS CDN go here -->
    <!------------------------------------------>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous">
        </script>
    <!-------------------------------------------->
    <!-- Other libraries and styles of your own -->
    <!-------------------------------------------->
    <!-- <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> -->
    <link rel="stylesheet" href="./styles/users.css">

</head>

<body>
    <!-- tes -->
    <!------------------------------>
    <!-- Your HTML Layout go here -->
    <!------------------------------>

    <!-- our own navbar goes here -->
    <!-- <nav id="navbarPlaceholder"></nav> -->

    <!-- the body of your page goes here -->
    <!-- stuff -->
    <div id="content">
        <table id="users">

        </table>
    </div>
    <form>
        <fieldset>
            <legend>Add a User</legend>
            <input type="text" placeholder="name" id="name" />
            <input type="email" placeholder="email" id="email" />
            <input type="password" placeholder="password" id="password" />
            <input type="button" id="add" value="Add" />
        </fieldset>
        <fieldset>
            <input type="button" id="delete" value="Delete" />
        </fieldset>
    </form>

    <p id="status"></p>
    <!-- our own footer goes here-->
    <!-- <nav id="footerPlaceholder"></nav> -->

    <!---------------------------------------------->
    <!-- Your own JavaScript functions go here    -->
    <!---------------------------------------------->
    <script>
        function getUsers() {
            const xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (this.readyState == XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        let data = JSON.parse(this.responseText);
                        console.log(this.responseText);
                        if (data.status == "success") {
                            let str = `<tr>
                                            <th class ="userid_header"><span>ID</span></th>
                                            <th class ="username_header"><span>Name</span></th>
                                            <th class ="email_header"><span>Email</span></th>
                                            <th class ="password_header"><span>Password</span></th>
                                        </tr>`;
                            console.log("data:", data);
                            for (let i = 0; i < data.rows.length; i++) {
                                let row = data.rows[i];
                                console.log("row", row);
                                str += ("<tr><td class = 'id'>" + row.ID
                                    + "</td><td class = 'name'><span>" + row.name
                                    + "</span></td><td class = 'email'><span>" + row.email
                                    + "</span></td><td class = 'password'><span>" + row.password
                                    + "</span></td></tr>");
                            }
                            // console.log(str);
                            document.getElementById("users").innerHTML = str;

                            let records = document.querySelectorAll("td[class='email'] span");
                            for (let j = 0; j < records.length; j++) {
                                records[j].addEventListener("click", edit);
                            }
                        } else {
                            console.log("Error!");
                        }
                    } else {
                        console.log(this.status);
                    }
                } else {
                    console.log("Error", this.status);
                }
            }
            xhr.open("GET", "/get-users");
            xhr.send();
        }

        getUsers();

        function edit(e) {
            let spanText = e.target.innerHTML;
            let parent = e.target.parentNode;
            let input = document.createElement("input");
            input.value = spanText;
            input.addEventListener("keyup", function (e) {
                let s = null;
                let v = null;
                if (e.which == 13) {
                    v = input.value;
                    let newSpan = document.createElement("span");
                    newSpan.addEventListener("click", edit);
                    newSpan.innerHtML = v;
                    parent.innerHTML = "";
                    parent.appendChild(newSpan);
                    let dataToSend = {
                        id: parent.parentNode.querySelector(".id").innerHTML,
                        name: parent.parentNode.querySelector(".name").innerHTML,
                        email: v,
                        password: parent.parentNode.querySelector(".password").innerHTML
                    };

                    const xhr = new XMLHttpRequest();
                    xhr.onload = function () {
                        if (this.readyState == XMLHttpRequest.DONE) {
                            if (xhr.status === 200) {
                                document.getElementById("status").innerHTML = "Record updated.";
                                getCustomers();
                            } else {
                                console.log(this.status);
                            }
                        } else {
                            console.log("ERROR", this.status);
                        }
                    }
                    xhr.open("POST", "/update-user");
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    console.log("dataToSend", "id=" + dataToSend.id + " name=" + dataToSend.name + " email=" + dataToSend.email + " password=" + dataToSend.password);
                    xhr.send("id=" + dataToSend.id + "&email=" + dataToSend.email);
                }
            });
            parent.innerHTML = "";
            parent.appendChild(input);
        }

        document.getElementById("add").addEventListener("click", (e) => {
            e.preventDefault();
            let formData = {
                name: document.getElementById("name").value,
                email: document.getElementById("email").value,
                password: document.getElementById("password").value
            };
            document.getElementById("name").value = "";
            document.getElementById("email").value = "";
            document.getElementById("password").value = "";

            const xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (this.readyState == XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        getUsers();
                        document.getElementById("status").innerHTML = "DB updated.";
                    } else {
                        console.log(this.status);
                    }
                } else {
                    console.log("ERROR", this.status);
                }
            }
            xhr.open("POST", "/add-user");
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.send("name=" + formData.name + "&email=" + formData.email + "&password=" + formData.password);
        })
    </script>
    <!-- <script src="./scripts/firebaseAPI_TEAM99.js"></script> -->
    <!-- <script src="./scripts/skeleton.js"></script> -->
    <!-- <script src="./scripts/script.js"></script> -->

</body>

</html>