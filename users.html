<!DOCTYPE html>
<html lang="en">

<head>
    <title>My BCIT Project</title>
    <meta name="comp1800 template" content="My 1800 App">

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap Library CSS JS CDN  -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous">
    </script>
    <link rel="stylesheet" href="../styles/users.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

</head>

<body>
    <section id="mainBody">
        <h2>Admin</h2>
        <p id="status"></p>
        <form>
            <div id="box1">
                <fieldset>
                    <legend>Add a User</legend>
                    <input type="text" placeholder="Username" id="name" />
                    <input type="email" placeholder="Email" id="email" />
                    <input type="password" placeholder="Password" id="password" />
                    <input type="text" placholder="isAdmin" id="isAdmin" />
                    <div class="buttons">
                        <input type="button" id="clear" name="clear" class="Clear" value="Clear">
                        <input type="button" id="add" value="Add" />
                    </div>
                </fieldset>
            </div>
            <fieldset id="box2">
                <legend>Delete a User</legend>
                <input type="text" placeholder="User ID" id="deleteID" />
                <input type="button" id="delete" value="Delete" />
            </fieldset>
        </form>
        <div id="content">
            <table id="users">
                <legend>Users</legend>
                <tr>
                    <th class="userid_header"><span>ID</span></th>
                    <th class="username_header"><span>Username</span></th>
                    <th class="email_header"><span>Email</span></th>
                    <th class="password_header"><span>Password</span></th>
                    <th class="admin_header"><span>Admin</span></th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>john</td>
                    <td>john@test.com</td>
                    <td>asdf1234</td>
                    <td>0</td>
                </tr>
            </table>
        </div>
    </section>

    <script>
        function getUsers() {
            const xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (this.readyState == XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        let data = JSON.parse(this.responseText);
                        if (data.status == "success") {
                            let str = `<tr>
                                            <th class ="userid_header"><span>ID</span></th>
                                            <th class ="username_header"><span>Name</span></th>
                                            <th class ="email_header"><span>Email</span></th>
                                            <th class ="password_header"><span>Password</span></th>
                                            <th class ="admin_header"><span>isAdmin</span></th>
                                        </tr>`;
                            for (let i = 0; i < data.rows.length; i++) {
                                let row = data.rows[i];
                                str += ("<tr><td class = 'id'>" + row.ID +
                                    "</td><td class = 'name'><span>" + row.name +
                                    "</span></td><td class = 'email'><span>" + row.email +
                                    "</span></td><td class = 'password'><span>" + row.password +
                                    "</span></td><td class = 'admin'><span>" + row.isAdmin +
                                    "</span></td></tr>");
                            }
                            document.getElementById("users").innerHTML = str;

                            let records = document.querySelectorAll(
                                "td.email span, td.name span, td.password span, td.admin span");
                            for (let j = 0; j < records.length; j++) {
                                records[j].addEventListener("click", edit);
                            }
                        } else {
                            console.log("Error!");
                        }
                    } else {
                        console.log(this.status);
                    }
                } else {
                    console.log("Error", this.status);
                }
            }
            xhr.open("GET", "/get-users");
            xhr.send();
        }

        getUsers();

        function edit(e) {
            let spanText = e.target.innerHTML;
            let parent = e.target.parentNode;
            let password = parent.parentNode.querySelector(".password");
            let email = parent.parentNode.querySelector(".email");
            let name = parent.parentNode.querySelector(".name");
            let isAdmin = parent.parentNode.querySelector(".admin");
            let input = document.createElement("input");
            input.value = spanText;
            input.addEventListener("keyup", function (e) {
                let s = null;
                let v = null;
                if (e.which == 13) {
                    v = input.value;
                    let newSpan = document.createElement("span");
                    newSpan.addEventListener("click", edit);
                    newSpan.innerHTML = v;
                    parent.innerHTML = "";
                    parent.appendChild(newSpan);
                    let dataToSend;
                    if (parent == email) {
                        dataToSend = {
                            id: parent.parentNode.querySelector(".id").innerHTML,
                            name: parent.parentNode.querySelector(".name span").innerHTML,
                            email: v,
                            password: parent.parentNode.querySelector(".password span").innerHTML,
                            isAdmin: parent.parentNode.querySelector(".admin span")
                        };
                    } else if (parent == name) {
                        dataToSend = {
                            id: parent.parentNode.querySelector(".id").innerHTML,
                            name: v,
                            email: parent.parentNode.querySelector(".email span").innerHTML,
                            password: parent.parentNode.querySelector(".password span").innerHTML,
                            isAdmin: parent.parentNode.querySelector(".admin span")
                        };
                    } else if (parent == password) {
                        dataToSend = {
                            id: parent.parentNode.querySelector(".id").innerHTML,
                            name: parent.parentNode.querySelector(".name span").innerHTML,
                            email: parent.parentNode.querySelector(".email span").innerHTML,
                            password: v,
                            isAdmin: parent.parentNode.querySelector(".admin span")
                        };
                    } else if (parent == isAdmin) {
                        dataToSend = {
                            id: parent.parentNode.querySelector(".id").innerHTML,
                            name: parent.parentNode.querySelector(".name span").innerHTML,
                            email: parent.parentNode.querySelector(".email span").innerHTML,
                            password: parent.parentNode.querySelector(".password span").innerHTML,
                            isAdmin: v
                        };
                    }
                    const xhr = new XMLHttpRequest();
                    xhr.onload = function () {
                        if (this.readyState == XMLHttpRequest.DONE) {
                            if (xhr.status === 200) {
                                document.getElementById("status").innerHTML = "Record updated.";
                                getUsers();
                            } else {
                                console.log(this.status);
                            }
                        } else {
                            console.log("ERROR", this.status);
                        }
                    }
                    xhr.open("POST", "/update-user");
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    xhr.send("id=" + dataToSend.id + "&name=" + dataToSend.name + "&email=" + dataToSend.email +
                        "&password=" + dataToSend.password + "&isAdmin=" + dataToSend.isAdmin);
                }
            });
            parent.innerHTML = "";
            parent.appendChild(input);
        }

        document.getElementById("add").addEventListener("click", (e) => {
            e.preventDefault();
            let formData = {
                name: document.getElementById("name").value,
                email: document.getElementById("email").value,
                password: document.getElementById("password").value,
                isAdmin: document.getElementById("isAdmin").value
            };
            document.getElementById("name").value = "";
            document.getElementById("email").value = "";
            document.getElementById("password").value = "";
            document.getElementById("isAdmin").value = "";

            const xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (this.readyState == XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        getUsers();
                        document.getElementById("status").innerHTML = "DB updated.";
                    } else {
                        console.log(this.status);
                    }
                } else {
                    console.log("ERROR", this.status);
                }
            }
            xhr.open("POST", "/add-user");
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.send("name=" + formData.name + "&email=" + formData.email + "&password=" + formData.password +
                "&isAdmin=" + formData.isAdmin);
        })

        document.getElementById("delete").addEventListener("click", (e) => {
            e.preventDefault();
            let formData = {
                id: document.getElementById("deleteID").value,
            }
            document.getElementById("deleteID").value = "";

            const xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (this.readyState == XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        getUsers();
                        document.getElementById("status").innerHTML = "Record deleted.";
                    } else {
                        console.log(this.status);
                    }
                } else {
                    console.log("ERROR", this.status);
                }
            }
            xhr.open("POST", "/delete-user");
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.send("id=" + formData.id);
        })
    </script>

</body>

</html>